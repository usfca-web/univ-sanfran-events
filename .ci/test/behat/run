#!/bin/bash

# Authenticate with Terminus
terminus -n auth:login --machine-token="$TERMINUS_TOKEN"

# Source $BASH_ENV
source $BASH_ENV

# Verbose mode and exit on errors
set -ex

# Create Drush aliases for Pantheon
terminus alpha:aliases --no-db-url --only="$TERMINUS_SITE"

# Sanity check the alias (USE REAL VARS)
./vendor/bin/drush sa "@pantheon.${TERMINUS_SITE}.${TERMINUS_ENV}"

# Drush Behat driver fails without this option (keep if you know you need it)
echo "\$options['strict'] = 0;" >> ~/.drush/pantheon.aliases.drushrc.php

# Dynamically set Behat configuration parameters
# IMPORTANT: Force the *remote* drush binary on Pantheon to /code/vendor/bin/drush
export BEHAT_PARAMS='{
  "extensions": {
    "Drupal\\DrupalExtension": {
      "drush": {
        "alias": "@pantheon.'"$TERMINUS_SITE"'.'"$TERMINUS_ENV"'",
        "binary": "${PWD}/vendor/bin/drush",
        "global_options": "--no-ansi"
      }
    },
    "Behat\\MinkExtension": {
      "base_url": "https://'"$TERMINUS_ENV"'-'"$TERMINUS_SITE"'.pantheonsite.io/",
      "sessions": {
        "default": { "browserkit_http": null }
      }
    }
  }
}'

# Start headless Chrome
echo "\n Starting Chrome in headless mode ..."
google-chrome --disable-gpu --headless --remote-debugging-address=0.0.0.0 --remote-debugging-port=9222 --no-sandbox </dev/null &>/dev/null &

echo "::::::::::::::::::::::::::::::::::::::::::::::::"
echo "Behat test site: $TERMINUS_SITE.$TERMINUS_ENV"
echo "::::::::::::::::::::::::::::::::::::::::::::::::"
echo

echo "PWD=$PWD"
ls -la vendor/bin || true
which drush || true
find . -maxdepth 4 -path "*/vendor/bin/drush" -print || true


# Build a runtime behat config so we don't rely on BEHAT_PARAMS being honored.
cat > /tmp/behat.runtime.yml <<EOF
default:
  formatters:
    progress: true

  suites:
    default:
      paths:
        - tests/behat/features
      contexts:
        - Drupal\\DrupalExtension\\Context\\DrupalContext
        - Drupal\\DrupalExtension\\Context\\MinkContext

  extensions:
    Behat\\MinkExtension:
      base_url: "https://${TERMINUS_ENV}-${TERMINUS_SITE}.pantheonsite.io/"
      sessions:
        default:
          browserkit_http: ~

    Drupal\\DrupalExtension:
      api_driver: "drush"
      drush:
        alias: "@pantheon.${TERMINUS_SITE}.${TERMINUS_ENV}"
        binary: "${PWD}/vendor/bin/drush"
        global_options: "--no-ansi"
EOF


# Run the Behat tests
./vendor/bin/behat --config=/tmp/behat.runtime.yml --strict --colors


